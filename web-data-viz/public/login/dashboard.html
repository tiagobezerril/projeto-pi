<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeWare | Dashboard</title>

    <link rel="shortcut icon" type="imagex/png" href="../img/logo.png">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=close,menu,personarrow_drop_downarrow_drop_up" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body>
    <header class="menu">
        <div class="esquerda">
            <span id="burguer" class="material-symbols-outlined" onclick="clickMenu()">
                menu
            </span>
        </div>
        <div class="centro">
            <a href="index.html" style="text-decoration: none"><span class="logo">SafeWare</span></a>
            <p class="titulo" id="nomeFilial">Filial X</p>
        </div>
        <div class="direita">
            <span id="sensores">
                
            </span>

            <a onclick="clickOpcoes()" class="perfil" id="setaPerfil">
                <span class="material-symbols-outlined" id="setaMenu">
                    arrow_drop_down
                </span>
            </a>
        </div>
    </header>

    <div id="menuPerfil">
        <a href="addFuncionario.html">Funcionários</a>
        <a onclick="clickEndereco()">Endereço</a>
        <a onclick="clickManutencao()">Manutenções</a>
        <a onclick="limparSessaoFunc()" style="border-radius: 0 0 1vh 1vh;">Sair</a>
    </div>

    <div id="opcoes">
        <div id="dashFiliais">

        </div>
        <a href="index.html" class="voltar">Voltar</a>
    </div>

    <div id="manutencao">
        <p class="titulo">Historico de manutenções</p>
        <span class="linha"></span>

        <div id="historico">

        </div>
        <span id="close" onclick="closeManu()" class="material-symbols-outlined">
            close
        </span>
    </div>
    <script data-jsd-embedded data-key="eb6df58d-df11-4966-8be2-7d3087316574" data-base-url="https://jsd-widget.atlassian.com" src="https://jsd-widget.atlassian.com/assets/embed.js"></script>

    <div id="endereco">
        <p class="titulo">Endereço</p>
        <div class="form">
            <p class="subtitulo">Atualize o endereço do estabelecimento</p>
            <p>Estado:</p>
            <select id="slcEstado">
                <option value="AC">Acre</option>
                <option value="AL">Alagoas</option>
                <option value="AP">Amapá</option>
                <option value="AM">Amazonas</option>
                <option value="BA">Bahia</option>
                <option value="CE">Ceará</option>
                <option value="ES">Espírito Santo</option>
                <option value="GO">Goiás</option>
                <option value="MA">Maranhão</option>
                <option value="MT">Mato grosso</option>
                <option value="MS">Mato grosso do Sul</option>
                <option value="MG">Minas gerais</option>
                <option value="PA">Pará</option>
                <option value="PB">Paraíba</option>
                <option value="PR">Paraná</option>
                <option value="PE">Pernambuco</option>
                <option value="PI">Piauí</option>
                <option value="RJ">Rio de Janeiro</option>
                <option value="RN">Rio Grande do Norte</option>
                <option value="RS">Rio Grande do Sul</option>
                <option value="RO">Rondônia</option>
                <option value="RR">Roraima</option>
                <option value="SC">Santa Catarina</option>
                <option value="SP">São Paulo</option>
                <option value="SE">Sergipe</option>
                <option value="TO">Tocantins</option>
            </select>
            <p>Cidade:</p>
            <input type="text" placeholder="Cidade" id="inpCidade">
            <p>Bairro:</p>
            <input type="text" placeholder="Bairro" id="inpBairro">
            <p>CEP:</p>
            <input type="number" placeholder="CEP" id="inpCEP">
            <p>Rua:</p>
            <input type="text" placeholder="Rua" id="inpRua">
            <p>Número:</p>
            <input type="number" placeholder="Número" id="inpNum">
            <span id="mensagemEnd"></span>
            <button onclick="atualizarEndereco()">Atualizar endereço</button>
        </div>
        <span id="close" onclick="clickClose()" class="material-symbols-outlined">
            close
        </span>
    </div>

    <div id="alerta" style="display: none;">
        <span class="card">
            <span id="closeAlerta" onclick="closeAlerta()" class="material-symbols-outlined">
                close
            </span>

            <img src='../img/aviso.png'>
            <p class='atencao'>Um vazamento foi detectado!</p> 
            <p>O sensor do fogão 1 acabou de detectar um vazamento, tome já as providências necessárias para a segurança do seu estabelecimento.</p>
        </span>
    </div>

    <div class="dash">
        <div class="cima">
            <div class="esquerda">
                <span class="spanTitulo">
                    <p id="tituloSensor" class="titulo">Sensor X</p>

                    <div class="onoff">
                        <p>Modo manutenção</p>
                        <input type="checkbox" class="toggle" id="onoff">
                        <label for="onoff"> </label>
                    </div>
                </span>

                <div class="divEsq">
                    <span>
                        <p class="graficoTitulo">Porcentagem de vazamento durante o dia</p>
                        <canvas id="graficoLinha1" class="graficoLinha1" width="100px"></canvas>
                    </span>
    
                    <div class="KPIs">
                        <span class="inicio">
                            <p class="nome">Horario de início</p>
                            <p class="dado">11:32:06</p>
                        </span>
                        <span class="final">
                            <p class="nome">Horario de encerramento</p>
                            <p class="dado" style="color: #e63535;">Ativo</p>
                        </span>
                        <span class="status alerta">
                            <p class="nome">Status de vazamento</p>
                            <p class="dado">Ativo</p>
                        </span>
                    </div>
                </div>
            </div>

            <div class="direita">
                <div class="metricas">
                    <span class="seguro">Seguro</span>
                    <span class="risco">Em risco</span>
                    <span class="extremo">Extremo risco</span>
                    
                    <p> 0% </p>
                    <p> >0% e <2% </p>
                    <p> >2% </p>
                </div>

                <span style="width: 180px;">
                    <p class="graficoTitulo">Porcentagem atual</p>
                    <canvas id="graficoMeia" class="meiaLua">Grafico</canvas>
                </span>
                   
                <div class="baixo">
                    <p class="graficoTitulo">Quantidade de vazamentos mensal</p>
                    <canvas id="graficoMensal" style="height: 200px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>

        var sensorAnalogico = new Chart(document.getElementById('graficoLinha1').getContext('2d'), {
        type: 'line',
        data: {
            datasets: [{
                label: 'Analogico',
                borderColor: '#e63535',
                backgroundColor: '#e63535'

            }]
        },
        options: {
            scales: {
                x: {
                    beginAtZero: true
                },
                y: {
                    title: {
                        display: true,
                        text: '(%)'
                    },
                    beginAtZero: true,
                },
            },
        }
    });

    var paginacao = {};
    var tempo = {};

    function obterDados(grafico, endpoint) {
        fetch('http://localhost:3300/sensores/' + endpoint)
            .then(response => response.json())
            .then(valores => {
                if (paginacao[endpoint] == null) {
                    paginacao[endpoint] = 0;
                }
                if (tempo[endpoint] == null) {
                    tempo[endpoint] = 0;
                }

                var ultimaPaginacao = paginacao[endpoint];
                paginacao[endpoint] = valores.length;
                valores = valores.slice(ultimaPaginacao);

                valores.forEach((valor) => {
                    if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
                        grafico.data.labels.shift();
                        grafico.data.datasets[0].data.shift();
                    }

                    grafico.data.labels.push(tempo[endpoint]++);
                    grafico.data.datasets[0].data.push(parseFloat(valor));
                    grafico.update();
                });
            })
            .catch(error => console.error('Erro ao obter dados:', error));
    }

    setInterval(() => {
        obterDados(sensorAnalogico, 'analogico');
        // obterDados(sensorDigital, 'digital');
    }, 1000);





        var idFilialAtual = JSON.parse(sessionStorage.idFilialAtual);
        var jsonFiliais = JSON.parse(sessionStorage.FILIAIS);
        var jsonSensores = JSON.parse(sessionStorage.SENSORES);
        var filialAtual = 0;
        var sensorAtual;
        var sensoresFilialAtual = [];

        window.onload = carregarDados(), obterDadosBarras(), obterDadosAtual();

        function carregarDados(){
            for(var i = 0; i < jsonFiliais.length; i++){
                if (jsonFiliais[i].idFilial == idFilialAtual){
                    filialAtual = jsonFiliais[i]; 
                }
            }

            for(var i = 0; i < jsonSensores.length; i++){
                if(jsonSensores[i].fkFilial == idFilialAtual){
                    sensoresFilialAtual.push(jsonSensores[i]);
                }
            }
            
            sensorAtual = sensoresFilialAtual[0];
            nomeFilial.innerHTML = filialAtual.endereco;
            exibirDados();
        }

        function direcionarDash(idFilial){
            sessionStorage.setItem('idFilialAtual', idFilial);
            window.location = "dashboard.html";
        };

        function exibirDados() {
            JSON.parse(sessionStorage.FILIAIS).forEach(item => {
                document.getElementById("dashFiliais").innerHTML += `
                        <a class="filial" onclick="direcionarDash(${item.idFilial})" style="text-decoration: none;">Filial - ${item.endereco}</a>
                        <span class="linha"></span>    
                    `;
            });

            sensoresFilialAtual.forEach(item => {
                document.getElementById("sensores").innerHTML += `
                    <button onclick="clickSensor(${item.idSensor})" id="botaoSensor${item.idSensor}">${item.local_inst}</button>
                `;
            })
            clickSensor(sensoresFilialAtual[0].idSensor);
        }

        function buscarEnderecoFilial(idFilial){
            fetch(`/empresas/buscarEnderecoFilial/${idFilial}`,{
                method: "GET",
            }).then(function(resposta){
                console.log(resposta)
                resposta.json().then(json => {
                    sessionStorage.setItem('ENDERECO', JSON.stringify(json.endereco));
                    console.log("Endereço armazenado: ", json.endereco);

                    carregarDadosEndereco();
                });
            }).catch(function(resposta){
                console.log(`#ERRO: ${resposta}`);
            });
        }

        function carregarDadosEndereco(){
            var jsonEndereco = JSON.parse(sessionStorage.ENDERECO); 
            slcEstado.value = jsonEndereco[0].estado;
            inpCidade.value = jsonEndereco[0].cidade;
            inpBairro.value = jsonEndereco[0].bairro;
            inpRua.value = jsonEndereco[0].logradouro;
            inpNum.value = jsonEndereco[0].numero;
            inpCEP.value = jsonEndereco[0].cep;
        }

        function buscarManutencaoFilial(){
            var idFilial = filialAtual.idFilial;

            fetch(`/empresas/buscarManutencaoFilial/${idFilial}`,{
                method: "GET",
            }).then(function(resposta){
                console.log(resposta)
                resposta.json().then(json => {
                    sessionStorage.setItem('MANUTENCAO', JSON.stringify(json.manutencao));
                    if (sessionStorage.MANUTENCAO == '[]'){
                        historico.innerHTML = 'Não houveram avisos de manutenções nessa filial'
                    } else {
                        console.log("Manutenção armazenadas: ", json.manutencao);

                        carregarManutencoes();
                    }                    
                });
            }).catch(function(resposta){
                console.log(`#ERRO: ${resposta}`);
            });
        }

        function carregarManutencoes(){
            var manutencoes = JSON.parse(sessionStorage.MANUTENCAO);

            manutencoes.forEach(item => {
                document.getElementById("historico").innerHTML += `
                          <span class="manutencao">
                            <h3>Sensor ${item.local_inst}</h3>
                            <span class="horario">
                                <b>Horario de inicio:</b> ${item.inicio} <br>
                                <b>Horario de término:</b> ${item.termino}
                            </span>
                        </span>
                    `;
            });
        }

        function atualizarEndereco(){
            var idFilial = filialAtual.idFilial;
            var estado = slcEstado.value;
            var cidade = inpCidade.value;
            var bairro = inpBairro.value;
            var cep = inpCEP.value;
            var rua = inpRua.value;
            var numero = inpNum.value;

            if(estado == '' || cidade == '' || bairro == '' || cep == '' || rua == '' || numero == ''){
                mensagemEnd.innerHTML = '<p style="color: #e63535">Preencha todos os campos.</p>';

                setTimeout(() => {
                    mensagemEnd.innerHTML = '';
                }, 2000);
            } else {
                fetch(`/empresas/atualizarEnderecoFilial`,{
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        idFilial: idFilial,
                        estado: estado,
                        cidade: cidade,
                        bairro: bairro,
                        cep: cep,
                        rua: rua,
                        numero: numero
                    })
                }).then(function(resposta){
                    console.log(resposta);
                    if(resposta.ok){
                        console.log('Endereço atualizado com sucesso!');
                        mensagemEnd.innerHTML = '<p style="color: #60CE60">Endereço atualizado com sucesso!</p>'
                        buscarEnderecoFilial();

                        setTimeout(() => {
                            mensagemEnd.innerHTML = '';
                        }, 2000);
                    } else {
                        console.error('Erro ao cadastrar endereço');
                    }
                }).catch(function(error){
                    console.error('Erro ao atualizar endereço: ', error.message);
                });
            }

        }

        function clickMenu() {
            if (opcoes.style.left == '-300px') {
                opcoes.style.left = '0';
            } else {
                opcoes.style.left = '-300px';
            }
        }

        function clickOpcoes() {
            if (endereco.style.right == '0'){
                menuPerfil.style.top = '-5vw';
                setaMenu.innerHTML = 'arrow_drop_down';
            } else if (menuPerfil.style.top == '-5vw') {
                menuPerfil.style.top = '5vw';
                setaMenu.innerHTML = 'arrow_drop_up';
            } else {
                menuPerfil.style.top = '-5vw';
                setaMenu.innerHTML = 'arrow_drop_down';
            }
        }       

        function clickManutencao(){
            buscarManutencaoFilial();
            manutencao.style.right = '0';
            clickOpcoes();
        }

        function closeManu(){
            manutencao.style.right = '-620px';
        }
    
        function clickEndereco() {
            buscarEnderecoFilial(filialAtual.idFilial);
            endereco.style.right = '0';
            clickOpcoes();
        }
    
        function clickClose() {
            endereco.style.right = '-620px';
        }

        function closeAlerta() {
            alerta.style.display = 'none';
        }
           
        function clickSensor(idSensor){
            for(var i = 0; i < sensoresFilialAtual.length; i++){
                if(sensoresFilialAtual[i].idSensor == idSensor){
                    sensorAtual = sensoresFilialAtual[i];
                }
            }
            tituloSensor.innerHTML = sensorAtual.local_inst;
        }

        var dadosGraficoBarra = [];

        function obterDadosBarras(){
            for (var i = 0; i < sensoresFilialAtual.length; i++){
                idSensorAtual = sensoresFilialAtual[i].idSensor;

                fetch(`/dashboard/obterDadosBarras/${idSensorAtual}`,{
                    method: 'GET',
                }).then(function(resposta){
                    console.log(resposta)
                    resposta.json().then(json => {
                        dadosGraficoBarra.push(json.dados);
                        console.log("Dados armazenados: ", json.dados);
                    });
                    
                });
            };

            setTimeout(() => {
                prepararDadosBarras();
            }, 1000);
        }

        var listaDatasets = [];
        var listaTotal = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

        function prepararDadosBarras(){
            var nomeSensor;
            
            for(var index = 0; index < dadosGraficoBarra.length; index++){
                var dadosAtual = dadosGraficoBarra[index];
                var tamanhoJsonAtual = dadosGraficoBarra[index].length;
                var listaMeses = []

                if (dadosGraficoBarra[index].length < 12){
                    for(var i = 0; i < tamanhoJsonAtual; i++){
                        listaMeses.push(dadosGraficoBarra[index][i].Mes)
                        nomeSensor = dadosGraficoBarra[index][i].local_inst;
                    }
                    var naoTem =[]
                    for(var i = 1; i <= 12; i++){
                        if(!listaMeses.includes(i)){
                            naoTem.push(i)
                        }
                    }
                    for(var i = 0; i < naoTem.length; i++){
                        dadosGraficoBarra[index].push({Mes: naoTem[i], qtdVazamentos: 0, local_inst: nomeSensor});
                    }
                }

                // Função para reordenar o json em ordem decrescente pelo numero do mês
                dadosAtual.sort((a, b) => a.Mes - b.Mes);
            };

            listaTotal = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            for(var index = 0; index < dadosGraficoBarra.length; index++){
                var listaDados = []
                for(var i = 0; i < 12; i++){
                    listaDados.push(dadosGraficoBarra[index][i].qtdVazamentos);
                    var nomeSensor = dadosGraficoBarra[index][i].local_inst;

                    // Calculando o total de vazamentos por mês
                    listaTotal[i] += dadosGraficoBarra[index][i].qtdVazamentos;
                }
                
                listaDatasets.push({
                    label: nomeSensor,
                    data: listaDados,
                    borderColor: '#6e65ec',
                    backgroundColor: '#6e65ec',
                });
            };

            listaDatasets.push({
                label: 'Total de vazamentos',
                data: listaTotal,
                borderColor: '#36317a',
                backgroundColor: '#36317a'
            });

            plotarGraficoBarras();
        }

        function plotarGraficoBarras(){
            var graficoGeral = document.getElementById('graficoMensal');

            var dadosGeral = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

            var configGeral = {
                responsive: false,
                type: 'bar',
                data: { 
                    labels: dadosGeral,
                    datasets: listaDatasets                
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            }

            chartGeral = new Chart(graficoGeral, configGeral);
        }

        function atualizarGraficoAtual(){           
            setInterval(() => {
                obterDadosAtual();
            }, 2000);
        }
        
        var dadoGraficoAtual;

        function obterDadosAtual(){
            idSensorAtual = sensorAtual.idSensor;

            fetch(`/dashboard/obterDadosAtual/${idSensorAtual}`,{
                method: 'GET',
            }).then(function(resposta){
                console.log(resposta)
                resposta.json().then(json => {
                    dadoGraficoAtual = json.dados;
                    console.log("Dados coletados: ", json.dados);
                }); 
            });

            setTimeout(() => {
                if (dadoGraficoAtual && dadoGraficoAtual.length > 0 && dadoGraficoAtual[0].porcentagem == undefined) {
                    valorAtual = [0, 100 - 0];
                    plotarGraficoAtual();
                } else {
                    setTimeout(() => {
                        valorAtual = [dadoGraficoAtual[0].porcentagem, 100 - dadoGraficoAtual[0].porcentagem];
                        plotarGraficoAtual();
                    }, 100);
                }
            }, 100)

            
        };

        var valorAtual;
        var myChart;
        
        function plotarGraficoAtual(){
            var corAtual = '#e63535';
            
            if (dadoGraficoAtual[0].porcentagem > 0) {
                corAtual = '#e63535';
            } else {
                corAtual = '#60CE60';
            }

            const vazamentoAtual = document.getElementById("graficoMeia").getContext('2d');

            if(myChart != undefined){
                myChart.data.datasets[0].data = valorAtual;
                myChart.data.datasets[0].backgroundColor = [corAtual, 'rgba(0, 0, 0, 0.1)']
                myChart.update();
            } else {
                const configVazamentoAtual = {
                    type: 'doughnut',
                    data: {
                        labels: ["Vazamento atual"],
                        datasets: [{
                            backgroundColor: [corAtual, 'rgba(0, 0, 0, 0.1)'],
                            borderWidth: 0,
                            data: valorAtual
                        }]
                    },
                    options: {
                        responsive: true,
                        cutoutPercentage: 85,
                        rotation: -90,
                        circumference: 180,
                        tooltips: {
                            enabled: false
                        },
                        legend: {
                            display: false
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: false
                        },
                        title: {
                            display: true,
                            text: "Vazamento atual",
                            fontSize: 16
                        }
                    }
                }    
                
                myChart = new Chart(vazamentoAtual, configVazamentoAtual);
                
                setTimeout(() => {
                    atualizarGraficoAtual();
                }, 300);
            }            
            // myChart.update();
        }


    </script>
</body>
</html>
