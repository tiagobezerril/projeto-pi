<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeWare | Dashboard</title>

    <link rel="shortcut icon" type="imagex/png" href="img/logo.png">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=close,menu,person" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header class="menu">
        <div class="esquerda">
            <span href="" id="burguer" class="material-symbols-outlined" onclick="clickMenu()">
                menu
            </span>
        </div>
        <div class="centro">
            <a href="" style="width: 100px; display: contents;"><span class="logo">SafeWare</span></a>
        </div>
        <div class="direita">
            <a onclick="clickPerfil()" class="perfil">
                <span class="material-symbols-outlined">
                    person
                </span>
            </a>
        </div>
    </header>

    <div id="opcoes">
        <span>Cozinha 1</span>
        <span class="linha"></span>
        <span></span>
        <span class="linha"></span>
        <span></span>
        <span class="linha"></span>
    </div>

    <div id="dadoSensores">
        <span class="esquerda">
            <p class="titulo">Cozinha 1</p>
        </span>
        <span class="direita">
            <button onclick="clickSensor(1)" id="butaoSensor1" class="alerta">Sensor 1</button>
            <button onclick="clickSensor(2)" id="butaoSensor2">Sensor 2</button>
            <button onclick="clickSensor(3)" id="butaoSensor3">Sensor 3</button>
        </span>
    </div>
    <div class="dash" id="sensor1">
        <div class="cima">
            <div class="esquerda">
                <span>
                    <p id="tituloSensor1" class="titulo alerta">Sensor 1</p>
                </span>
                <span>
                    <p class="graficoTitulo">Porcentagem de vazamento durante o dia</p>
                    <canvas id="sensorAnalogico1" class="graficoLinha"></canvas>
                </span>
            </div>
            <div class="direita">
                <span>
                    <p class="graficoTitulo">Porcentagem atual</p>
                    <canvas id="graficoMeia" class="meiaLua">Grafico</canvas>
                </span>

                <div class="KPIs">
                    <span class="inicio">
                        <p class="nome">Horario de início</p>
                        <p class="dado">12:32:06</p>
                    </span>
                    <span class="final">
                        <p class="nome">Horario de encerramento</p>
                        <p class="dado">--</p>
                    </span>
                    <span class="status alerta">
                        <p class="nome">Status de vazamento</p>
                        <p class="dado">Em andamento</p>
                    </span>
                </div>
            </div>
        </div>

        <div class="baixo">
            <span>
                <label>Mês: </label>
                <select id="">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Março</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </span>
            
        </div>
        <div class="baixo2">
            <p class="graficoTitulo">Quantidade de vazamentos Mensal Cozinha 01 </p>
            <canvas id="teste" style="width: 100%;"></canvas>

        </div>
    </div>

    <div class="dash" id="sensor2">

        <div class="cima">
            <div class="esquerda">
                <span>
                    <p id="tituloSensor2" class="titulo">Sensor 2</p>
                </span>
                <span>
                    <p class="graficoTitulo">Porcentagem de vazamento durante o dia</p>
                    <canvas id="sensorAnalogico2" class="graficoLinha"></canvas>
                </span>
            </div>
            <div class="direita">
                <span>
                    <p class="graficoTitulo">Porcentagem atual</p>
                    <canvas id="estaticoMeia" class="meiaLua">Grafico</canvas>
                </span>

                <div class="KPIs">
                    <span class="inicio">
                        <p class="nome">Horario de início</p>
                        <p class="dado">--</p>
                    </span>
                    <span class="final">
                        <p class="nome">Horario de encerramento</p>
                        <p class="dado">--</p>
                    </span>
                    <span class="status seguro">
                        <p class="nome">Status de vazamento</p>
                        <p class="dado">Sem vazamento</p>
                    </span>
                </div>
            </div>
        </div>

        <div class="baixo">
            <span>
                <label>Mês: </label>
                <select id="">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Março</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </span>
            <p class="graficoTitulo">Quantidade de vazamentos por sensor</p>
            <canvas id="graficoMes2"></canvas>
        </div>
    </div>

    <div class="dash" id="sensor3">

        <div class="cima">
            <div class="esquerda">
                <span>
                    <p id="tituloSensor3" class="titulo">Sensor 3</p>
                </span>
                <span>
                    <p class="graficoTitulo">Porcentagem de vazamento durante o dia</p>
                    <canvas id="sensorAnalogico3" class="graficoLinha"></canvas>
                </span>
            </div>
            <div class="direita">
                <span>
                    <p class="graficoTitulo">Porcentagem atual</p>
                    <canvas id="estaticoMeia" class="meiaLua">Grafico</canvas>
                </span>

                <div class="KPIs">
                    <span class="inicio">
                        <p class="nome">Horario de início</p>
                        <p class="dado">--</p>
                    </span>
                    <span class="final">
                        <p class="nome">Horario de encerramento</p>
                        <p class="dado">--</p>
                    </span>
                    <span class="status seguro">
                        <p class="nome">Status de vazamento</p>
                        <p class="dado">Sem vazamento</p>
                    </span>
                </div>
            </div>
        </div>

        <div class="baixo">
            <span>
                <label>Mês: </label>
                <select id="">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Março</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </span>
            <p class="graficoTitulo">Quantidade de vazamentos por sensor</p>
            <canvas id="graficoMes3"></canvas>
        </div>
    </div>

    <div id="perfil">
        <p class="titulo">Perfil</p>
        <span class="linha"></span>
        <div class="form">
            <p class="subtitulo">Atualize o endereço do estabelecimento</p>
            <p for="">Estado:</p>
            <select id="">
                <option value="AC">Acre</option>
                <option value="AL">Alagoas</option>
                <option value="AP">Amapá</option>
                <option value="AM">Amazonas</option>
                <option value="BA">Bahia</option>
                <option value="CE">Ceará</option>
                <option value="ES">Espírito Santo</option>
                <option value="GO">Goiás</option>
                <option value="MA">Maranhão</option>
                <option value="MT">Mato grosso</option>
                <option value="MS">Mato grosso do Sul</option>
                <option value="MG">Minas gerais</option>
                <option value="PA">Pará</option>
                <option value="PB">Paraíba</option>
                <option value="PR">Paraná</option>
                <option value="PE">Pernambuco</option>
                <option value="PI">Piauí</option>
                <option value="RJ">Rio de Janeiro</option>
                <option value="RN">Rio Grande do Norte</option>
                <option value="RS">Rio Grande do Sul</option>
                <option value="RO">Rondônia</option>
                <option value="RR">Roraima</option>
                <option value="SC">Santa Catarina</option>
                <option value="SP">São Paulo</option>
                <option value="SE">Sergipe</option>
                <option value="TO">Tocantins</option>
            </select>
            <p for="">Cidade:</p>
            <input type="text" placeholder="Cidade">
            <p for="">Rua:</p>
            <input type="text" placeholder="Rua">
            <p for="">Número:</p>
            <input type="number" placeholder="Número">
            <button>Enviar</button>
        </div>
        <span id="close" onclick="clickClose()" class="material-symbols-outlined">
            close
        </span>
    </div>
</body>

</html>
<script>
    function clickMenu() {
        if (opcoes.style.left == '-300px') {
            opcoes.style.left = '0';
        } else {
            opcoes.style.left = '-300px';
        }
    }

    function clickPerfil() {
        if (perfil.style.right == '-620px') {
            perfil.style.right = '0';
        } else {
            perfil.style.right = '-620px';
        }
    }

    function clickClose() {
        perfil.style.right = '-620px';
    }

    window.onload = clickSensor(1)

    // melhor jeito e otimizado para diferenciar os sensores
    function clickSensor(sensorClicado) { // RECEBENDO PARAMETRO PARA SABER O SENSOR QUE FOI CLICADO

        // TODA VEZ QUE CLICA ELE GERA UM CHART NOVO, ENTÃO TEMOS QUE DESTRUIR OS ANTIGOS

        // DESTRUINDO OS 3 CHARTS POR CAUSA QUE ELE ACUSA QUE JÁ EXISTE
        for (var i = 0; i <= 3; i++) {
            let chartStatus = Chart.getChart("sensorAnalogico" + i); // DESTRUINDO OS 3 CHARTS DE LINHA
            if (chartStatus != undefined) {
                chartStatus.destroy();
            }
        }

        if (sensorClicado == 1) {
            sensor1.style.display = 'flex';
            sensor2.style.display = 'none';
            sensor3.style.display = 'none';
        } else if (sensorClicado == 2) {
            sensor1.style.display = 'none';
            sensor2.style.display = 'flex';
            sensor3.style.display = 'none';
        } else if (sensorClicado == 3) {
            sensor1.style.display = 'none';
            sensor2.style.display = 'none';
            sensor3.style.display = 'flex';
        }

        // DADOS "MOCKADOS" com valores aleatórios para os 3 sensores

        //COMENTAR QUANDO FOR CONECTAR NA API
        const dadosDefault = [
            { dtinstalacao: '05h', sensor:  0},
            { dtinstalacao: '06h', sensor:  1},
            { dtinstalacao: '07h', sensor:  0},
            { dtinstalacao: '08h', sensor:  0},
            { dtinstalacao: '09h', sensor:  0},
            { dtinstalacao: '10h', sensor:  0},
            { dtinstalacao: '11h', sensor:  3},
            { dtinstalacao: '12h', sensor:  0},
            { dtinstalacao: '13h', sensor:  0},
            { dtinstalacao: '14h', sensor:  0},
            { dtinstalacao: '15h', sensor:  2},
            { dtinstalacao: '16h', sensor:  0},
            { dtinstalacao: '17h', sensor:  0},
            { dtinstalacao: '18h', sensor:  0},
            { dtinstalacao: '19h', sensor:  0},
            { dtinstalacao: '20h', sensor:  0},
            { dtinstalacao: '21h', sensor:  0},
            { dtinstalacao: '22h', sensor:  0},
            { dtinstalacao: '23h', sensor:  0},
            { dtinstalacao: '00h', sensor:  0}
        ];

        var dadosSensor = dadosDefault.map(dado => dado.sensor) // COMENTAR QUANDO FOR CONECTAR NA API
        var dadosLabel = dadosDefault.map(dado => dado.dtinstalacao) // COMENTAR QUANDO FOR CONECTAR NA API

        const configDefault = {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Analogico',
                    borderColor: '#e63535',
                    backgroundColor: '#e63535',
                    data: dadosSensor // COMENTAR QUANDO FOR CONECTAR NA API
                }],
                labels: dadosLabel // COMENTAR QUANDO FOR CONECTAR NA API
            },
            options: {
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        title: {
                            display: true,
                            text: '(%)'
                        },
                        beginAtZero: true,
                    },
                },
            }
        }

        var sensorAnalogico = document.getElementById('sensorAnalogico' + sensorClicado).getContext('2d')
        var grafico = new Chart(sensorAnalogico, configDefault);


        /*
            QUANDO JÁ ESTIVER FUNCIONANDO CONECTADO AO BANCO, BASTA DESCOMENTAR AS LINHAS ABAIXO

            EXPLICAÇÃO: O jeito genério já indica qual "sensorClicado" está sendo clicado, após isso, basta pegar a variável "sensorClicado"
            e fazer "requisição" no banco para trazer o sensor pelo id

            feito isso, ele vai gerar o valor automaticamente
        */


        // DESCOMENTAR QUANDO FOR CONECTAR NA API
        // setInterval(() => { 

        // fazer requisição no banco
            // obterDados(grafico, 'analogico', sensorClicado); // DESCOMENTAR DEPOIS, COMENTADO PARA TESTES
            // obterDados(sensorDigital, 'digital'); // deixar comentado
        // }, 1000);
    }


    var paginacao = {};
    var tempo = {};

    function obterDados(grafico, endpoint, graficoEscolhido) {
        // endpoint completo = /sensores/analogico/1 - exemplo
        fetch('http://localhost:3000/sensores/' + endpoint + "/" + graficoEscolhido) // buscar dados do grafico escolhido 
        /*

        SERÁ NECESSÁRIO FAZER UM ENDPOINT NA API QUE BUSCA POR ID DO GRAFICO NO BANCO PARA FUNCIONAR O "graficoEscolhido" POR ID
        */
            .then(response => response.json())
            .then(valores => {
                if (paginacao[endpoint] == null) {
                    paginacao[endpoint] = 0;
                }
                if (tempo[endpoint] == null) {
                    tempo[endpoint] = 0;
                }

                var ultimaPaginacao = paginacao[endpoint];
                paginacao[endpoint] = valores.length;
                valores = valores.slice(ultimaPaginacao);

                valores.forEach((valor) => {
                    if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
                        grafico.data.labels.shift();
                        grafico.data.datasets[0].data.shift();
                    }

                    grafico.data.labels.push(tempo[endpoint]++);
                    grafico.data.datasets[0].data.push(parseFloat(valor));
                    grafico.update();
                });
            })
            .catch(error => console.error('Erro ao obter dados:', error));
    }



    /// --------------------------SEGUNDO GRAFICO----------------------------------------------------------

    // CONFIGURAÇÃO DO GRAFICO DE BAIXO 
    const configVazamentoAtual = {
        type: 'doughnut',
        data: {
            labels: ["Vazamento Sensor 01 / Fogão 01"],
            datasets: [{
                backgroundColor: ['#8E94E6', 'rgba(0, 0, 0, 0.1)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutoutPercentage: 85,
            rotation: -90,
            circumference: 180,
            tooltips: {
                enabled: false
            },
            legend: {
                display: false
            },
            animation: {
                animateRotate: true,
                animateScale: false
            },
            title: {
                display: true,
                text: "Vazamento Atual Sensor 01 / Fogão 01",
                fontSize: 16
            }
        }
    }

    // PERCORRENDO 3 VEZES 
    for (var i = 1; i <= 3; i++) {

        // CADA VEZ QUE RODAR, PEGA UM GRAFICO DIFERENTE (1, 2 E ASSIM VAI)
        var vazamentoAtual = document.getElementById("graficoMeia").getContext('2d')
        // CRIANDO CHART
        var chart = new Chart(vazamentoAtual, configVazamentoAtual)

        // GERANDO NÚMERO DE VAZAMENTO ALEATÓRIO
        const numeroAleatorio = parseInt(Math.random() * 45)


        if (i == 1) { // SE FOR O "SENSOR 1" GERA ALEATÓRIO
            chart.data.datasets[0].data = [numeroAleatorio, 45 - numeroAleatorio]
            chart.update()
        } else { // OS DEMAIS SENSORES TEM DE ESTAR 0 NO VAZAMENTO
            chart.data.datasets[0].data = [0, 45 - 0]
            chart.update()
        }

    }

    const ctx = document.getElementById('teste').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                datasets: [
                    {
                        label: 'SENSOR01 - FOGÃO 01',
                        data: [45, 40, 38, 37, 33, 25],
                        backgroundColor: 'steelblue',
                        borderColor: 'steelblue',
                        borderWidth: 1
                    },
                    {
                        label: 'SENSOR02 - FOGÃO 02',
                        data: [39, 40, 43, 38, 29, 27],
                        backgroundColor: '#32cd32',
                        borderColor: '#32cd32',
                        borderWidth: 1
                    },
                    {
                        label: 'SENSOR01 - FORNO 01',
                        data: [44, 39, 42, 35, 31, 29],
                        backgroundColor: '#ffcbdb',
                        borderColor: '#ffcbdb',
                        borderWidth: 1
                    },
                    {
                        label: 'SENSOR01 - FORNO 02',
                        data: [41, 37, 43, 32, 24, 31],
                        backgroundColor: '#23238E',
                        borderColor: '#23238E',
                        borderWidth: 1
                    },
                    {
                        label: 'Consumo Total',
                        data: [36, 39, 44, 41, 37, 34],
                        backgroundColor: '#A020F0',
                        borderColor: '#A020F0',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

</script>